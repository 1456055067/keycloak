#!/bin/bash
# Pre-commit hook for Keycloak Rust
# Per CONTRIBUTING.md rules 5, 6, 7

set -e

echo "ğŸ” Running pre-commit checks..."

# Change to the rust-migration directory
cd "$(git rev-parse --show-toplevel)/rust-migration"

# Rule 6: Always run Cargo fmt before commits
echo "ğŸ“ Running cargo fmt..."
cargo fmt --all --check
if [ $? -ne 0 ]; then
    echo "âŒ cargo fmt check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi
echo "âœ… cargo fmt passed"

# Rule 5: Always run Cargo Clippy before commits
echo "ğŸ” Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings
if [ $? -ne 0 ]; then
    echo "âŒ cargo clippy failed. Fix the warnings before committing."
    exit 1
fi
echo "âœ… cargo clippy passed"

# Rule 7: Always run Cargo audit before commits
echo "ğŸ”’ Running cargo audit..."
cargo audit
if [ $? -ne 0 ]; then
    echo "âŒ cargo audit found vulnerabilities. Update dependencies before committing."
    exit 1
fi
echo "âœ… cargo audit passed"

echo "ğŸ‰ All pre-commit checks passed!"
